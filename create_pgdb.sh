#!/bin/bash
set -euo pipefail

# ========================================
# üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
# ========================================
DB_SUPERUSER="postgres"        # –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å PostgreSQL
DB_NAME="pyramid2"              # –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
DB_USER="pyramid"              # –ò–º—è —Å–æ–∑–¥–∞–≤–∞–µ–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
DB_PASS="1234"                 # –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

# ========================================
# üß© –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è PostgreSQL
# ========================================
if ! psql -V &>/dev/null; then
    echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω PostgreSQL."
    exit 1
fi
# ========================================
# üß© –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
# ========================================
echo "‚ñ∂Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL –∫–∞–∫ $DB_SUPERUSER..."
sudo -u $DB_SUPERUSER psql -c '\q'|| {
    echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL."
    exit 1
}
echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ."

# ========================================
# üë§ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω–µ—Ç)
# ========================================
echo "‚ñ∂Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è '$DB_USER'..."
sudo -u $DB_SUPERUSER psql -v ON_ERROR_STOP=1 <<SQL
DO \$\$
BEGIN
   IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '${DB_USER}') THEN
      RAISE NOTICE '–°–æ–∑–¥–∞—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${DB_USER}...';
      CREATE USER ${DB_USER} WITH PASSWORD '${DB_PASS}';
   ELSE
      RAISE NOTICE '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${DB_USER} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.';
   END IF;
END
\$\$;
SQL

# ========================================
# üóÑ –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω–µ—Ç)
# ========================================
echo "‚ñ∂Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∞–∑—ã '$DB_NAME'..."
DB_EXISTS=$(sudo -u $DB_SUPERUSER psql -t -c "SELECT 1 FROM pg_database WHERE datname = '${DB_NAME}'")

if [ -z "$DB_EXISTS" ]; then
    echo "–°–æ–∑–¥–∞—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö ${DB_NAME}..."
    sudo -u $DB_SUPERUSER psql -c "CREATE DATABASE ${DB_NAME} WITH ENCODING 'utf8' OWNER ${DB_USER};"
else
    echo "–ë–∞–∑–∞ ${DB_NAME} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º."
fi

# ========================================
# üîê –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤
# ========================================
echo "‚ñ∂Ô∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ –±–∞–∑–µ '$DB_NAME'..."

sudo -u $DB_SUPERUSER psql -d postgres -v ON_ERROR_STOP=1 <<SQL
-- –ü—Ä–∞–≤–∞ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ postgres)
REVOKE CONNECT ON DATABASE ${DB_NAME} FROM PUBLIC;
GRANT CONNECT ON DATABASE ${DB_NAME} TO ${DB_USER};
SQL

sudo -u $DB_SUPERUSER psql -d ${DB_NAME} -v ON_ERROR_STOP=1 <<SQL
-- –ü—Ä–∞–≤–∞ –Ω–∞ —Å—Ö–µ–º—É public (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ë–î)
REVOKE ALL ON SCHEMA public FROM PUBLIC;
GRANT ALL ON SCHEMA public TO ${DB_USER};
SQL

# ========================================
# ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
# ========================================
echo "‚úÖ –í—Å—ë –≥–æ—Ç–æ–≤–æ:"
echo "   ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${DB_USER}"
echo "   ‚Ä¢ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${DB_NAME}"
echo "   ‚Ä¢ –í–ª–∞–¥–µ–ª–µ—Ü –±–∞–∑—ã: ${DB_USER}"
